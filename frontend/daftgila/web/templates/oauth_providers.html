{% extends "base.html" %}

{% block title %}OAuth Provider Management - Auth Demo{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        Add New OAuth Provider
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.create_oauth_provider') }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Provider Name</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   placeholder="e.g., google, github, facebook" required>
                            <small class="text-muted">Unique identifier for the provider</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="client_id" class="form-label">Client ID</label>
                            <input type="text" class="form-control" id="client_id" name="client_id" required>
                            <small class="text-muted">OAuth client ID from the provider</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="client_secret" class="form-label">Client Secret</label>
                            <input type="password" class="form-control" id="client_secret" name="client_secret" required>
                            <small class="text-muted">OAuth client secret from the provider</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="authorize_url" class="form-label">Authorization URL</label>
                            <input type="url" class="form-control" id="authorize_url" name="authorize_url" required>
                            <small class="text-muted">OAuth authorization endpoint</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="token_url" class="form-label">Token URL</label>
                            <input type="url" class="form-control" id="token_url" name="token_url" required>
                            <small class="text-muted">OAuth token exchange endpoint</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userinfo_url" class="form-label">User Info URL</label>
                            <input type="url" class="form-control" id="userinfo_url" name="userinfo_url" required>
                            <small class="text-muted">User information endpoint</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="scope" class="form-label">Scope</label>
                            <input type="text" class="form-control" id="scope" name="scope" 
                                   placeholder="e.g., openid email profile" required>
                            <small class="text-muted">OAuth scope values (space-separated)</small>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                            <label class="form-check-label" for="is_active">Active</label>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Create Provider
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        OAuth Provider Configuration
                    </h5>
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-2"></i>Back to Admin
                    </a>
                </div>
                <div class="card-body">
                    {% if providers %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Client ID</th>
                                        <th>Status</th>
                                        <th>URLs</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for provider in providers %}
                                    <tr>
                                        <td>
                                            <strong>{{ provider.name|title }}</strong>
                                            <br>
                                            <small class="text-muted">ID: {{ provider.id }}</small>
                                        </td>
                                        <td>
                                            <code class="small">{{ provider.client_id[:20] }}{% if provider.client_id|length > 20 %}...{% endif %}</code>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if provider.is_active else 'danger' }}">
                                                {{ 'Active' if provider.is_active else 'Inactive' }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="small">
                                                <div><strong>Auth:</strong> <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ provider.authorize_url }}">{{ provider.authorize_url }}</span></div>
                                                <div><strong>Token:</strong> <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ provider.token_url }}">{{ provider.token_url }}</span></div>
                                                <div><strong>UserInfo:</strong> <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ provider.userinfo_url }}">{{ provider.userinfo_url }}</span></div>
                                                <div><strong>Scope:</strong> <code class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ provider.scope }}">{{ provider.scope }}</code></div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if provider.created_at %}
                                                <small>{{ provider.created_at.split('T')[0] }}</small>
                                            {% else %}
                                                <small class="text-muted">Unknown</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editModal{{ provider.id }}"
                                                        title="Edit Provider">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form method="POST" 
                                                      action="{{ url_for('admin.delete_oauth_provider', provider_id=provider.id) }}"
                                                      class="d-inline"
                                                      onsubmit="return confirm('Are you sure you want to delete the OAuth provider \"{{ provider.name }}\"? This action cannot be undone.')">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger"
                                                            title="Delete Provider">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No OAuth Providers Configured</h5>
                            <p class="text-muted">Add your first OAuth provider using the form on the left.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Provider Modals -->
{% for provider in providers %}
<div class="modal fade" id="editModal{{ provider.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit OAuth Provider: {{ provider.name|title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                            <form method="POST" action="{{ url_for('admin.update_oauth_provider', provider_id=provider.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_name{{ provider.id }}" class="form-label">Provider Name</label>
                                <input type="text" class="form-control" id="edit_name{{ provider.id }}" 
                                       name="name" value="{{ provider.name }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_client_id{{ provider.id }}" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="edit_client_id{{ provider.id }}" 
                                       name="client_id" value="{{ provider.client_id }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_client_secret{{ provider.id }}" class="form-label">Client Secret</label>
                                <input type="password" class="form-control" id="edit_client_secret{{ provider.id }}" 
                                       name="client_secret" placeholder="Leave blank to keep current secret">
                                <small class="text-muted">Only fill this if you want to change the secret</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_authorize_url{{ provider.id }}" class="form-label">Authorization URL</label>
                                <input type="url" class="form-control" id="edit_authorize_url{{ provider.id }}" 
                                       name="authorize_url" value="{{ provider.authorize_url }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_token_url{{ provider.id }}" class="form-label">Token URL</label>
                                <input type="url" class="form-control" id="edit_token_url{{ provider.id }}" 
                                       name="token_url" value="{{ provider.token_url }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_userinfo_url{{ provider.id }}" class="form-label">User Info URL</label>
                                <input type="url" class="form-control" id="edit_userinfo_url{{ provider.id }}" 
                                       name="userinfo_url" value="{{ provider.userinfo_url }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_scope{{ provider.id }}" class="form-label">Scope</label>
                                <input type="text" class="form-control" id="edit_scope{{ provider.id }}" 
                                       name="scope" value="{{ provider.scope }}" required>
                                <small class="text-muted">OAuth scope values (space-separated)</small>
                            </div>
                            
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="edit_is_active{{ provider.id }}" 
                                       name="is_active" {{ 'checked' if provider.is_active }}>
                                <label class="form-check-label" for="edit_is_active{{ provider.id }}">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Provider</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Quick Setup Templates -->
<div class="modal fade" id="quickSetupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick OAuth Provider Setup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Google OAuth</h6>
                        <div class="card">
                            <div class="card-body">
                                <p class="small text-muted">Copy these values to the form:</p>
                                <ul class="list-unstyled small">
                                    <li><strong>Name:</strong> google</li>
                                    <li><strong>Auth URL:</strong> https://accounts.google.com/o/oauth2/v2/auth</li>
                                    <li><strong>Token URL:</strong> https://oauth2.googleapis.com/token</li>
                                    <li><strong>UserInfo URL:</strong> https://www.googleapis.com/oauth2/v2/userinfo</li>
                                    <li><strong>Scope:</strong> openid email profile</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>GitHub OAuth</h6>
                        <div class="card">
                            <div class="card-body">
                                <p class="small text-muted">Copy these values to the form:</p>
                                <ul class="list-unstyled small">
                                    <li><strong>Name:</strong> github</li>
                                    <li><strong>Auth URL:</strong> https://github.com/login/oauth/authorize</li>
                                    <li><strong>Token URL:</strong> https://github.com/login/oauth/access_token</li>
                                    <li><strong>UserInfo URL:</strong> https://api.github.com/user</li>
                                    <li><strong>Scope:</strong> read:user user:email</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-fill form with common OAuth provider configurations
function fillProviderTemplate(providerName) {
    const templates = {
        'google': {
            name: 'google',
            authorize_url: 'https://accounts.google.com/o/oauth2/v2/auth',
            token_url: 'https://oauth2.googleapis.com/token',
            userinfo_url: 'https://www.googleapis.com/oauth2/v2/userinfo',
            scope: 'openid email profile'
        },
        'github': {
            name: 'github',
            authorize_url: 'https://github.com/login/oauth/authorize',
            token_url: 'https://github.com/login/oauth/access_token',
            userinfo_url: 'https://api.github.com/user',
            scope: 'read:user user:email'
        }
    };
    
    const template = templates[providerName];
    if (template) {
        document.getElementById('name').value = template.name;
        document.getElementById('authorize_url').value = template.authorize_url;
        document.getElementById('token_url').value = template.token_url;
        document.getElementById('userinfo_url').value = template.userinfo_url;
        document.getElementById('scope').value = template.scope;
    }
}

// Add quick setup buttons
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[action*="create"]');
    if (form) {
        const nameField = document.getElementById('name');
        const quickSetupDiv = document.createElement('div');
        quickSetupDiv.className = 'mb-3';
        quickSetupDiv.innerHTML = `
            <label class="form-label">Quick Setup</label>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-info btn-sm" onclick="fillProviderTemplate('google')">
                    <i class="fab fa-google me-1"></i>Google
                </button>
                <button type="button" class="btn btn-outline-dark btn-sm" onclick="fillProviderTemplate('github')">
                    <i class="fab fa-github me-1"></i>GitHub
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#quickSetupModal">
                    <i class="fas fa-question-circle me-1"></i>Help
                </button>
            </div>
        `;
        nameField.parentNode.insertBefore(quickSetupDiv, nameField.nextSibling);
    }
});
</script>
{% endblock %}

<!-- The end. -->
